---
title: "Weight Summary"
author: "RSG"
date: "08/19/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include = FALSE}
library(data.table) # for data manipulation
library(knitr) # for knitting
library(kableExtra) # for nicer tables
library(dplyr) # for piping
library(tmrtools)
library(tigris)
library(ggplot2)

knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(fig.width = 10)
knitr::opts_chunk$set(echo = TRUE)

# New puma data
puma_data = fread('puma_groups_xwalk.csv', colClasses = 'character')
puma_data[`PUMA Group` == 5, `PUMA Group`:=4]


# output from population sim. it provides a quasi-dummy coded survey data table
incidence_table = fread("output/final_incidence_table.csv")

# what we are trying to match to
targets         = fread("data/control_totals_puma_groups.csv")

# the calculated weights
weights = fread("output/final_summary_hh_weights.csv")

targets[, puma_group := as.character(puma_group)]

hh_data = weights[incidence_table, on = .(hh_id)]
hh_data[, puma_group := as.character(puma_group)]

# renaming some variables so we can rely on existing processes for summarizing weights
hh_data[, final_weight := puma_group_balanced_weight]
hh_data[, initial_weight := sample_weight]


# Defined pum groups for 2020 pumas
puma_group_list = lapply(split(puma_data, puma_data[['PUMA Group']]), function(x) x$PUMACE2010)
puma_labels = unname(
  sapply(names(puma_group_list),
         function(x) paste0('Group ', x,' (', paste(puma_group_list[[x]], collapse = ', '),')')
         )
  )

# puma_labels = c(
#       'Group 1 (7301:7306, 7319:7322)',
#       'Group 2 (7307, 7308, 7313, 7314)',
#       'Group 3 (7309, 7311, 7312)',
#       'Group 4 (7310, 7315, 7316)',
#       'Group 5 (7317, 7318)')

hh_data[,
  puma_group := factor(puma_group,
    levels = 1:length(puma_group_list),
    labels = puma_labels)]

targets[,
  puma_group := factor(puma_group,
    levels = 1:length(puma_group_list),
    labels = puma_labels)]

hh_data[, groupBy := puma_group]
targets[, groupBy := puma_group]

# 2020 data isn't out yet so we're just going ot use 2019 for now but label it with 2020 codes
pumas = tigris::pumas('CA', cb = TRUE, year = 2019)
pumas = ggplot2::fortify(pumas, region = 'PUMACE10')
pumas = pumas[as.numeric(pumas$PUMACE10) %in% 7301:7322,]

pumas$puma_group = NA
pumas$puma_group[as.numeric(pumas$PUMACE10) %in% c(7301:7306, 7319:7322)] = 1
pumas$puma_group[as.numeric(pumas$PUMACE10) %in% c(7307, 7308, 7313, 7314)] = 2
pumas$puma_group[as.numeric(pumas$PUMACE10) %in% c(7309, 7311, 7312)] = 3
pumas$puma_group[as.numeric(pumas$PUMACE10) %in% c(7310, 7315, 7316)] = 4
pumas$puma_group[as.numeric(pumas$PUMACE10) %in% c(7317, 7318)] = 4

# pumas$puma_group = factor(
#   pumas$puma_group,
#   levels = 1:5,
#   labels = c(
#     'Group 1 (7301:7306, 7319:7322)',
#     'Group 2 (7307, 7308, 7313, 7314)',
#     'Group 3 (7309, 7311, 7312)',
#     'Group 4 (7310, 7315, 7316)',
#     'Group 5 (7317, 7318)'))

pumas$puma_group = factor(
  pumas$puma_group,
  levels = 1:length(puma_group_list),
  labels = puma_labels)

palette = c('#173F5F', '#20639B', '#3CAEA3', '#F6D55C', '#ED553B')

m = ggplot(pumas)+
  geom_sf(color = 'black', size = 0.3, aes(fill = puma_group))+
  coord_sf() +
  #theme_map()+
  scale_fill_discrete(type = palette) + 
  theme(legend.position = 'bottom', 
        legend.direction = 'vertical')
  ggtitle("PUMA Groups for San Diego County")

```

#### PUMA Aggregation

| PUMA Group | PUMACE2010 | PUMACE2020 | Label                                                                                     |
| ---------- | ---------- | ---------- | ----------------------------------------------------------------------------------------- |
| 2          | 7313       | 7313       | San Diego County (Central)--El Cajon & Santee Cities PUMA                                 |
| 2          | 7307       | 7307       | San Diego County (Central)--Lakeside,  Winter Gardens & Ramona PUMA                       |
| 2          | 7314       | 7314       | San Diego County (Central)--San Diego (East Central/Navajo) & La Mesa Cities PUMA         |
| 2          | 7308       | 7308       | San Diego County (Central)--San Diego (Northeast/Rancho Bernardo) & Poway Cities PUMA     |
| 3          | 7312       | 7312       | San Diego County (Central)--San Diego City (Central/Mira Mesa & University Heights) PUMA  |
| 1          | 7302       | 7302       | San Diego County (North & East)--Fallbrook,  Alpine & Valley Center PUMA                  |
| 1          | 7304       | 7324       | San Diego County (Northwest)--Carlsbad City PUMA                                          |
| 1          | 7306       | 7306       | San Diego County (Northwest)--Escondido City (East) PUMA                                  |
| 1          | 7301       | 7301       | San Diego County (Northwest)--Oceanside City & Camp Pendleton PUMA                        |
| 1          | 7305       | 7325       | San Diego County (Northwest)--San Marcos & Escondido (West) Cities PUMA                   |
| 1          | 7303       | 7323       | San Diego County (Northwest)--Vista City PUMA                                             |
| 1          | 7319       | 7328       | San Diego County (South Central)--Lemon Grove City,  La Presa & Spring Valley PUMA        |
| 4          | 7316       | 7316       | San Diego County (South Central)--San Diego City (Central/Centre City & Balboa Park) PUMA |
| 5          | 7317       | 7317       | San Diego County (South Central)--San Diego City (Central/Mid-City) PUMA                  |
| 1          | 7322       | 7322       | San Diego County (South)--San Diego City (South/Otay Mesa & South Bay) PUMA               |
| 5          | 7318       | 7327       | San Diego County (South)--San Diego City (Southeast/Encanto & Skyline) PUMA               |
| 1          | 7321       | 7330       | San Diego County (Southwest)--Chula Vista (West) & National City Cities PUMA              |
| 1          | 7320       | 7329       | San Diego County (Southwest)--Sweetwater Region--Chula Vista City (East) PUMA             |
| 4          | 7315       | 7315       | San Diego County (West Central)--San Diego City (Central/Clairemont & Kearny Mesa) PUMA   |
| 3          | 7311       | 7311       | San Diego County (West Central)--San Diego City (Northwest/Del Mar Mesa) PUMA             |
| 3          | 7309       | 7326       | San Diego County (West)--San Diego (Northwest/San Dieguito) & Encinitas Cities PUMA       |
| 4          | 7310       | 7310       | San Diego County (West)--San Diego City (Southwest/Central Coastal) PUMA                  |

#### Map of PUMAs

```{r pumas}

plot(m)

```

#### Weight Summary

Summary of weights

```{r weight_summary, results = 'asis'}

tab = hh_data[!puma_group_balanced_weight == 0,
  .(.N,
    min    = round(min(puma_group_balanced_weight), 2),
    mean   = round(mean(puma_group_balanced_weight), 2),
    median = round(median(puma_group_balanced_weight), 2),
    max    = round(max(puma_group_balanced_weight), 2),
    sd     = round(sd(puma_group_balanced_weight), 2)),
  .(puma_group)][order(puma_group)]

tab = tab %>% kable(format = 'pandoc', row.names = FALSE)

tab

```

#### Ratio Summary

Summary of ratio of weights to initial weights

```{r ratio_summary, results = 'asis'}

tab = hh_data[!puma_group_balanced_weight == 0,
  .(min    = round(min(puma_group_balanced_weight / sample_weight), 2),
    mean   = round(mean(puma_group_balanced_weight / sample_weight), 2),
    median = round(median(puma_group_balanced_weight / sample_weight), 2),
    max    = round(max(puma_group_balanced_weight / sample_weight), 2),
    sd     = round(sd(puma_group_balanced_weight / sample_weight), 2)),
  .(puma_group)][order(puma_group)]

tab = tab %>% kable(format = 'pandoc', row.names = FALSE)

tab

```

#### Totals

Total of weights

```{r totals, results = 'asis'}
ptot = fread('../../inputs/acs/acs_race_table_cnty21.csv')[variable=='B02001_001', estimate]
htot = fread('../../inputs/acs/acs_hh_occupied_cnty21.csv')[variable=='B25002_002', estimate]

tots = data.table(
  'Target' = round(c(htot, ptot)),
  'Estimate' = c(hh_data[,sum(final_weight)], hh_data[,sum(final_weight*p_total)]),
  '% Error' = round(100*c((hh_data[,sum(final_weight)] - htot)/htot,  (hh_data[,sum(final_weight*p_total)] - ptot)/ptot),2)
  )

tots = tots %>% kable(format = 'pandoc', row.names = FALSE)
tots

```


### Validation of Final weights

```{r plots_11, echo = FALSE, results = "asis"}

for (p in targets[, puma_group]) {
  
  print(plot_weights(
    hh_data[!puma_group_balanced_weight == 0 & puma_group == p],
    targets[puma_group == p],
    weight_type = "final",
    title = "Final Expansion Comparison"))
  
}


```

```{r plots_overall, echo = FALSE, results = "asis"}
hh_data_overall = hh_data[!puma_group_balanced_weight == 0, !c('puma_group')]
hh_data_overall$groupBy = 'Total Region'

targets_overall = targets[,!c('puma_group','groupBy')][,lapply(.SD, sum)]
targets_overall$groupBy = 'Total Region'

print(plot_weights(
  hh_data_overall,
  targets_overall,
  weight_type = "final",
  title = "Overall Final Expansion Comparison"))

```
